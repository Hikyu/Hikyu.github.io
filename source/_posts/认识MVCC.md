---
layout: post
title: 认识MVCC
date: 2017-11-02 20:18:07
categories: 编程
tags: 
- 数据库
---
前一篇总结提到了数据库事务的隔离性可以由锁机制来实现。锁是传统数据库控制事务并发的主要手段，这里提到的锁(S锁和X锁)可以认为是悲观锁，在对数据实现读写之前加上相应的锁，实现了独占访问机制，从而控制并发行为。神通数据库7.0主要使用了锁来实现事务并发控制。

那么数据库事务的并发控制还有其他的实现方式吗？当然是有的。去年刚推出的神通数据库8.0，就使用了MVCC(Multiversion Concurrency Control) 即多版本控制来控制事务的并发行为。

研究一下什么是MVCC...

## MVCC

> 多版本并发控制技术,它使得大部分支持行锁的事务引擎,不再单纯的使用行锁来进行数据库的并发控制,取而代之的是,把数据库的行锁与行的多个版本结合起来,只需要很小的开销,就可以实现非锁定读,从而大大提高数据库系统的并发性能.

多版本并发控制，意味着同一时刻看到的相同行的数据可能是不一样的,即一个行可能有多个版本.有点平行宇宙的意思。要实现这种效果，需要做一些操作：

- 对于每一行记录，新增两个隐藏列：

  行的更新时间(创建版本号)

  行的删除时间(删除版本号)

- 数据版本

  同一行数据，在同一时刻对于不同的事务，可能看到不同的版本。即同一行数据有多个版本同时存在。

- 事务版本

  每个事务有其唯一的事务版本号

- 版本有序

  无论是数据版本，还是事务版本，其版本号随时间增长而增长，即版本号是递增的。

<!-- more -->

## MVCC 与 数据库事务隔离级别

对于INSERT，DELETE，UPDATE语句，MVCC是如何处理的？

- INSERT时，保存当前事务版本号为行的创建版本号

- DELETE时，保存当前事务版本号为行的删除版本号

- UPDATE时，插入一条新纪录，保存当前事务版本号为行创建版本号，同时保存当前事务版本号到原来删除的行（还有另外一种实现方式，即把旧数据放入回滚段当中，其他事务读数据时，从回滚段中读出）

MVCC由于其实现原理,只支持read committed和repeatable read隔离等级：

- 提交读

  SELECT时，读取当前查询语句之前已经提交的结果

  因此，SELECT看得见其自身所在事务中前面更新执行结果或者在查询执行期间其它事务已提交的数据

- 可重复读

  SELECT时，读取创建版本号<=当前事务版本号，删除版本号为空或>当前事务版本号

  因此，事务内部的同样的SELECT命令总是看到相同的数据

上面提到的读操作，读取的都是数据的快照版本，即"快照读"，读取数据库当前版本数据的方式，叫做"当前读"。在MVCC中：

- 快照读：即select

  select * from table ....;

- 当前读：特殊的读操作，插入/更新/删除操作，属于当前读，处理的都是当前的数据，需要加锁。

  select * from table where ? lock in share mode;

  select * from table where ? for update;

  insert;

  update ;

  delete;

## MVCC 与 乐观并发控制

通过上面的总结可以看出，MVCC是主要用来解决"读-写冲突"的无锁并发控制。读操作时不用阻塞写操作，写操作不用阻塞读操作，同时避免了脏读。

那么乐观并发控制是什么呢？乐观并发控制假设认为数据一般情况下不会造成冲突，所以先进行修改，在提交事务前，检查一下事务开始后，有没有新提交改变，如果没有就提交，如果有就放弃并重试(或返回错误让用户处理)。可以看出，乐观并发控制是用来解决"写-写冲突"的无锁并发控制。

那么，在使用了MVCC之后，如何解决"写-写冲突"呢？

有两种方法：

1. 结合传统的悲观锁控制写-写冲突

就像上面提到的"当前读"，遇到更新语句，对数据加X锁

MySQL中将MVCC与2PL结合起来，实现了事务并发控制。

2. 使用乐观并发控制解决写-写冲突

PostgreSQL中将MVCC与乐观并发控制结合起来，实现了事务的并发控制。

## 总结

由上文可以得出，MVCC在每次读时避免了加锁开销，适用于"读多写少"的场景。增加了事务的并发度，同时避免了死锁的发生；

但是当写-写冲突增加时，基于乐观并发控制的MVCC会有更多的retry发生，如果事务的执行时间很长，回滚后再执行反而会造成性能降低。

## 参考

[Databases 101: ACID, MVCC vs Locks, Transaction Isolation Levels, and Concurrency](http://ithare.com/databases-101-acid-mvcc-vs-locks-transaction-isolation-levels-and-concurrency/)