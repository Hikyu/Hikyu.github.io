---
title:  联通华为HG8347R设置桥接模式
date: 2018-04-30 19:43:12
categories: 
- 技术
- 工具
tags: linux
---

[前面的笔记](http://yukai.space/2017/06/05/%E5%A6%82%E4%BD%95%E4%BB%8E%E5%A4%96%E7%BD%91%E8%AE%BF%E9%97%AE%E5%AE%B6%E9%87%8C%E7%9A%84%E7%94%B5%E8%84%91/)中有提到如何通过外网访问家里的服务。在某些场景下可能会用到，比如想要在单位ssh家里的电脑，或者访问家里的NAS等设备等等。之前用的电信的宽带，是通过自己的路由器拨号上网，并且外网IP也是直接分配好的，配一下DDNS和端口映射即可。前一段时间换了联通的宽带。

更换宽带的时候，联通提供了一个光猫，华为HG8347R。这个光猫取代了之前的路由器，拨号也由他进行。通过该光猫的无线功能就可以直接连接WIFI上网了。但是这个光猫的无线性能较差，于是在 Lan1 口接了一个自己的TP-link路由器，通过该路由器提供的wifi信号可以正常上网。此时出现了两个WIFI信号，一个是光猫提供的，一个是TP-link路由器提供的。家里的终端设备都使用TP-link提供的WIFI上网。此时的网络拓扑大致如下：

{% asset_img route.png 拓扑 %}

<!-- more -->

上面的拓扑显示了从Internet到家里的终端设备经过了三层NAT转发，分别是联通到光猫，光猫到TP-link，TP-link到终端。

换成联通的宽带后，NAT转发的层数多了，一定程度上会影响网速。另一方面，如果还想从外网访问家里终端的服务，面临两个问题：

第一，联通分给用户的是一个 172.16 打头的局域网IP，肯定是不可以从外网直接访问的；

第二，联通提供的光猫没有提供DDNS和端口映射等高级功能。

此时就有必要更改一下光猫的配置了。

## 基础知识

首先了解一下路由器的几种工作模式：

- AP(接入点)模式：

AP(接入点)模式下，只需要把一根可以上网的网线插在路由器上，无需任何配置就可以通过有线和无线上网了，相当于一台拥有无线功能的交换机。

适用场合：宾馆、酒店或者其它提供了一根网线上网的场所。

- Router(无线路由)模式

在Router(无线路由)模式下，路由器就相当于一台普通的无线宽带路由器。家里的ADSL或者光猫安装好之后，可以通过路由模式，让无线路由器使用PPPoE（虚拟拨号）连接光猫拨号上网。

适用场合：用户自己办理了宽带业务情况下使用。

- Repeater（中继）模式

Repeater（中继）模式下，路由器会通过无线的方式与一台可以上网的无线路由器建立连接，用来放大可以上网的无线路由器上的无线信号。

适用场合：有一台可以上网的无线路由器，但是该无线路由器的无线信号覆盖有限，希望无线信号可以覆盖更广泛的范围时使用。

- Bridge（桥接）模式

Bridge（桥接）模式，路由器会通过无线的方式与一台可以上网的无线路由器建立连接，用来放大可以上网的无线路由器上的无线信号；

适用场合：有一台可以上网的无线路由器，但是该无线路由器的无线信号覆盖有线，希望无线信号可以覆盖更广泛的范围时使用。

- Client（客户端）模式

像笔记本电脑上的无线网卡那样工作，仅连接其它的无线网络，而不发射自己的无线网络信号。这种模式相当于启用了一个无线的WAN口，且下面的电脑只能通过有线方式接到此设备。

适用场合：附近有无线信号，并且用户知道该无线信号密码，用户的台式电脑想连接该无线信号上网时使用。

注意，中继和桥接这两种模式看起来相似。其内部本质上的不同为：

中继模式下无线路由器仍然提供DHCP及NAT功能，即接入到该无线路由器的终端组成的是一个单独的局域网网段。和原来的无线路由器的LAN口及无线客户接入不在同一个网段。

桥接模式下接入到该无线路由器上的终端，是和主无线网网络处在相同的网段。内部的DHCP请求，也会被转发到主无线网络上。

## 修改光猫配置

有了上面的基础，我们回头看此时的拓扑情况：

光猫工作在路由模式下，拨号上网；

TP-link 工作在接入点模式下，连接光猫的Lan1口。

如果我们想要使用TP-link的DDNS和端口转发功能，那么首先就需要TP-link获得外网IP的地址，也就是说让TP-link取代光猫的位置，由TP-link来拨号上网。

此时TP-link需要工作在【路由模式】下，而光猫则需要改为【桥接模式】，这样TP-link才能与光猫的Wan口处在同一网段，才可以进行拨号。

如何修改光猫的工作模式？网上翻了不少资料，大部分是讲解如何破解光猫的。不过，我找到了一个更加简单的办法，那就是直接使用光猫的超级管理员账户，就可以修改光猫的工作模式啦！

在此之前，首先需要获得拨号上网的账号密码。这个账号密码在光猫里配好的，但是密码是加密的，不太容易取得，直接拨打10010，询问客服，获得账号密码。

接下来修改光猫的配置：

1. 登录光猫的Web管理页面

   我的光猫的Web页面是：http://192.168.18.1/CU.html，使用账户 CUAdmin   密码 CUAdmin 登入。

   注意，一定要加上**CU.html**，否则会提醒你该操作不允许！

2. 进入基本设置->上行线路配置

    有四个上行线路，分别是管理电话、互联网、IPTV和声音什么的。选择第二个 2_Internet_xxx；

    模式该为桥接，选择端口1进行绑定;

    关闭光猫的无线功能和DHCP功能。

3. TP-link接Lan1端口

    进入TP-link提供的Web管理界面 http://192.168.1.1/，路由设置->上网设置；

    上网方式选择宽带拨号上网，填写从客服处获取的宽带账号密码，点击连接。

    不出意外的话，可以连接成功，已经可以上网了。

但是，此时在TP-link上看到的路由器Wan口IP地址仍然是内网IP 172.16.X.X，所以还是无法使用DDNS和端口映射等功能。

## 取得公网IP

拨打10010，向客服索要外网IP地址，而不是联通NAT分配的私有地址。

做完以上的操作，DDNS、DMZ、端口映射等功能又可以用啦！

## 疑问

修改光猫的配置为桥接模式后，就无法访问光猫的Web管理页面了。Ping 192.168.18.1 也显示超时。然后我将电脑用网线直接接光猫的Lan2口，是可以访问192.168.18.1的。

这说明光猫的地址没有变，但是为什么用TP-link上网之后却Ping不通该地址呢？TP-link接光猫的Lan1口，两者应该是相通的才对呀？

TP-link的Wan口变成了外网IP，光猫与TP-link之间的网络拓扑是怎样的呢？

以上。